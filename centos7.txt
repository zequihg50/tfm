set -e

PREFIX='/home/zequi/tfm/sw'
mkdir -p $PREFIX


# Need to compile from source for parallel support
#yum search hdf5 | awk '/hdf5/{print $1}' | tail -n+2 | xargs yum install -y
#yum search netcdf | awk '/netcdf/{print $1}' | tail -n+2 | xargs yum install -y


# Required packages
yum groupinstall -y "Development Tools"
yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum install -y wget openmpi openmpi-devel
yum install -y python36 python36-pip python36-devel # netcdf4-python
yum install -y libcurl-devel zlib-devel # for netcdf-c

hdf5() {
  wget 'https://s3.amazonaws.com/hdf-wordpress-1/wp-content/uploads/manual/HDF5/HDF5_1_10_5/source/hdf5-1.10.5.tar.gz'
  tar -xf hdf5-1.10.5.tar.gz
  pushd hdf5-1.10.5
  ./configure --enable-parallel --prefix=$PREFIX --enable-hl
  make
  make install
  popd
}

netcdfc() {
  if [ ! -d "netcdf-c" ]; then
    git clone https://github.com/Unidata/netcdf-c
  fi
  pushd netcdf-c
  git checkout v4.6.3

  CPPFLAGS="-I/usr/include/openmpi-x86-64 -I$PREFIX/include" LDFLAGS="-L$PREFIX/lib" ./configure --prefix $PREFIX --enable-parallel
  make
  make install
  popd
}

netcdfpython() {
  if [ ! -d "netcdf4-python" ]; then
    git clone https://github.com/Unidata/netcdf4-python
  fi
  pushd netcdf4-python
  git checkout v1.4.3.2
  export PATH=$PREFIX/bin:$PATH # nc-config
  sudo pip3 install numpy cython
  HDF5_DIR="$PREFIX" HDF5_INCDIR="$PREFIX/include" HDF5_LIBDIR="$PREFIX/lib" NETCDF4_DIR="$PREFIX" NETCDF4_INCDIR="$PREFIX/include" NETCDF4_LIBDIR="$PREFIX/lib" python3 setup.py build
  HDF5_DIR="$PREFIX" HDF5_INCDIR="$PREFIX/include" HDF5_LIBDIR="$PREFIX/lib" NETCDF4_DIR="$PREFIX" NETCDF4_INCDIR="$PREFIX/include" NETCDF4_LIBDIR="$PREFIX/lib" sudo -E python3 setup.py install
  cd test
  python3 run_all.py
  popd
}

hdf5
netcdfc

# mpi4py
export PATH=/usr/lib64/openmpi/bin:$PATH
LDFLAGS="-L/usr/lib64/openmpi/lib" CPPFLAGS="-I/usr/include/openmpi-x86_64" pip3 install mpi4py

netcdfpython
